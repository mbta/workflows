on:
  workflow_call:
    inputs:
      project:
        type: string
        required: false
        description: The Asana project to manipulate.
      merged-section:
        type: string
        required: false
        description: The Asana project section for tickets with PRs that have been merged.
      review-section:
        type: string
        required: false
        description: The Asana project section for tickets with PRs that have a review requested.
    secrets:
      asana-token:
        required: false
      asana-github-secret:
        required: true
jobs:
  move-to-merged-asana-ticket-job:
    runs-on: ubuntu-latest
    if: inputs.merged-section != '' && github.actor != 'dependabot[bot]' &&  github.event.pull_request.merged == true
    steps:
      - name: Github-Asana action from Insurify
        uses: insurify/github-asana-action@v1.0.3
        with:
          asana-pat: ${{ secrets.asana-token }}
          trigger-phrase: "\\*\\*Asana Ticket:\\*\\*"
          targets: '[{"project": "${{ inputs.project }}", "section": "${{ inputs.merged-section }}"}]'
  move-to-in-review-asana-ticket-job:
    runs-on: ubuntu-latest
    if: inputs.review-section != '' && github.actor != 'dependabot[bot]' && github.event.action == 'review_requested'
    steps:
      - name: Github-Asana action from Insurify
        uses: insurify/github-asana-action@v1.0.3
        with:
          asana-pat: ${{ secrets.asana-token }}
          trigger-phrase: "\\*\\*Asana Ticket:\\*\\*"
          targets: '[{"project": "${{ inputs.project }}", "section": "${{ inputs.review-section }}"}]'
  create-asana-attachment-job:
    runs-on: ubuntu-latest
    name: Create pull request attachments on Asana tasks
    if: github.actor != 'dependabot[bot]'
    steps:
      - name: Create pull request attachments
        uses: Asana/create-app-attachment-github-action@v1.2
        id: postAttachment
        with:
          asana-secret: ${{ secrets.asana-github-secret }}
      - name: Log output status
        run: echo "Status is ${{ steps.postAttachment.outputs.status }}"
